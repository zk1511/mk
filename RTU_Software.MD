# RTU软件

## 传感器
* `注意资源共享互斥`
### 雨量传感器
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，开始读取数据，数据读取中，数据读取完成，休眠状态，故障状态。
* 雨量相关属性
* 雨量传感器故障码
#### 2. 方法
* 初始化
* 读取雨量数据
* 进入低功耗
* 退出低功耗
* 读取传感器状态
#### 3. 实现方法
* 外部中断+RTC 记录脉冲数（休眠状态下可唤醒）

### 水位传感器
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，开始读取数据，数据读取中，数据读取完成，休眠状态，故障状态。
* 水位相关属性
* 水位传感器故障码
#### 2. 方法
* 初始化
* 读取水位数据
* 进入低功耗
* 退出低功耗
* 读取传感器状态
#### 3. 实现方法
* 485总线读取（串口）或者 ADC采样

### 图像传感器
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，开始读取数据，数据读取中，数据读取完成，休眠状态，故障状态。
* 图像相关属性（图像数据需存储）
* 图像传感器故障码
#### 2. 方法
* 初始化
* 读取图像数据（存储到相关位置）
* 进入低功耗
* 退出低功耗
* 读取传感器状态
#### 3. 实现方法
* 485总线读取数据存储到相应位置，建议加入文件系统保存为文件

### 温湿度传感器
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，开始读取数据，数据读取中，数据读取完成，休眠状态，故障状态。
* 温湿度相关属性
* 温湿度传感器故障码
#### 2. 方法
* 初始化
* 读取温湿度数据
* 进入低功耗
* 退出低功耗
* 读取传感器状态
#### 3. 实现方法
* IIC 读取温湿度
***
## ADC采集

### 电池电压
#### 1. 属性
* 模块状态：~~断电，上电，~~初始化，初始化完成，开始读取数据，数据读取中，数据读取完成，休眠状态，故障状态。
* 电池电压相关属性
* 电池电压故障码
#### 2. 方法
* 初始化
* 读取电池电压数据
* 进入低功耗
* 退出低功耗
* 读取传感器状态
#### 3. 实现方法
* ADC 读取电压值

### 充电电压
#### 1. 属性
* 模块状态：~~断电，上电，~~初始化，初始化完成，开始读取数据，数据读取中，数据读取完成，休眠状态，故障状态。
* 充电电压相关属性
* 充电电压故障码
#### 2. 方法
* 初始化
* 读取充电电压数据
* 进入低功耗
* 退出低功耗
* 读取传感器状态
#### 3. 实现方法
* ADC 读取电压值

***

## 看门狗
### 外部硬件看门狗
* 系统启动前初始化
* 主任务喂狗
* 休眠由RTC唤醒后执行喂狗

### 内部硬件看门狗
* 系统启动前初始化
* 主任务喂狗
* 休眠由RTC唤醒后执行喂狗

### 多任务软件看门狗
* 多任务软件看门狗，各个子任务开始时申请看门狗，可设置超时时间，看门狗开关；
* 子任务若开启看门狗则需喂狗
* 软件看门狗服务：再系统定时器中消耗已激活看门狗的计数器
* 主任务中负责监测已激活的软件看门狗是否超时

***
## LCD
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，~~开始读取数据，数据读取中，数据读取完成，休眠状态，~~故障状态。
* 显示相关属性
* 背光状态
* LCD故障码
#### 2. 方法
* 初始化
* 显示数据
* 进入低功耗（关显示）
* 退出低功耗（开显示）
* 读取LCD状态
* 开背光
* 关背光
#### 3. 实现方法
* 8080总线读写LCD，IO控制背光

***
## 蓝牙
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，数据接受中，数据接收完成，发送数据，发送数据完成，休眠状态，故障状态。
* 蓝牙相关属性
* 蓝牙故障码
#### 2. 方法
* 初始化
* 进入低功耗
* 退出低功耗
* 读取连接状态
* BLE软件复位
* BLE硬件复位
* BLE电源开关
#### 3. 实现方法
* 串口通讯，中断接收，放入缓存。

***
## 电源管理
* 12V供电控制
* 24V供电控制
* 蓝牙供电控制

***
## 网络通讯部分
#### 1. 属性
* 模块状态：断电，上电，初始化，初始化完成，休眠状态，故障状态。
* 网络模块相关属性
* 网络模块故障码
#### 2. 方法
* 初始化,模块识别（2G，4G）,获取相关信息（IMEI，ICCID）
* 进入低功耗
* 退出低功耗
* 软件复位
* 硬件复位
* 电源开关
* 模块类型
* 建立连接
* 发送数据
* 接收数据
* 网络连接状态查询
* 信号查询
* 网络类型查询
* 故障码查询
* 模块状态查询
* 时间查询
* 获取定位信息
#### 3. 实现方法
* 串口通讯，中断接收，放入缓存队列，待应用层处理；发送数据进入发送队列，由发送任务发送。


***
## RTOS
* RT-thread
***
## 中间件
### shell
* finish
### spiflash驱动
* SFUD
### 文件系统
* fatfs 
* spifs 
* easyflash
### 日志
* ulog
* easylog
### 错误追踪
* CmBacktrace
### AT组件

***
## RTOS任务分配

### 主任务

***
## 应用层逻辑

### 网络通讯

### 蓝牙通讯

### 离线存储

### 参数设置

### 软件调试

### 生产测试

### 低功耗

### 远程升级

### 故障管理




